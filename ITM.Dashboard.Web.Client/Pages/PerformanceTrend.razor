@* // ITM.Dashboard.Web.Client/Pages/PerformanceTrend.razor *@

@page "/performance-trend"
@using ITM.Dashboard.Web.Client.Models
@using ITM.Dashboard.Web.Client.Shared
@inject IHttpClientFactory HttpClientFactory
@inject ISnackbar Snackbar
@implements IAsyncDisposable

<PageTitle>Performance</PageTitle>

<MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
    <MudIcon Icon="@Icons.Material.Rounded.Insights" Size="Size.Large" />
    <MudText Typo="Typo.h4">Performance</MudText>
</MudStack>

<MudPaper Class="pa-4 mb-4">
    <MudGrid Spacing="2" AlignItems="AlignItems.Center">
        <MudItem xs="12" sm="4" md="1">
            <MudSelect T="string" Label="Site" Value="_selectedSite" ValueChanged="OnSiteChanged"
                       Dense="true" Margin="Margin.Dense" Variant="Variant.Text"
                       Disabled="@(_filterState == FilterState.RealTime)">
                @foreach (var site in _sites)
                {
                    <MudSelectItem T="string" Value="@site">@site</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="4" md="2">
            <MudSelect T="string" Label="SDWT" Value="_selectedSdwt" ValueChanged="OnSdwtChanged"
                       Dense="true" Margin="Margin.Dense" Variant="Variant.Text"
                       Disabled="@(_filterState < FilterState.SelectSdwt || _filterState == FilterState.RealTime)">
                @foreach (var sdwt in _sdwts)
                {
                    <MudSelectItem T="string" Value="@sdwt">@sdwt</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="4" md="2">
            <MudAutocomplete @ref="_eqpIdAutocomplete" T="string" Label="EQP ID"
                             Value="_selectedEqpId" ValueChanged="OnSelectedEqpIdChanged"
                             SearchFunc="SearchEqpids"
                             Dense="true" Margin="Margin.Dense" Variant="Variant.Text"
                             ResetValueOnEmptyText="true" CoerceText="false" CoerceValue="false"
                             Disabled="@(_filterState < FilterState.SelectEqpId || _filterState == FilterState.RealTime)" />
        </MudItem>
        <MudItem xs="6" sm="6" md="2">
            <MudDatePicker Label="Start Date" @bind-Date="_startDate"
                           Dense="true" Margin="Margin.Dense" Variant="Variant.Text"
                           Disabled="@(_filterState < FilterState.ReadyToSearch || _filterState == FilterState.RealTime)" />
        </MudItem>
        <MudItem xs="6" sm="6" md="2">
            <MudDatePicker Label="End Date" @bind-Date="_endDate"
                           Dense="true" Margin="Margin.Dense" Variant="Variant.Text"
                           Disabled="@(_filterState < FilterState.ReadyToSearch || _filterState == FilterState.RealTime)" />
        </MudItem>
        <MudItem xs="4" sm="3" md="1">
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                       OnClick="OnSearchClicked" FullWidth="true"
                       Disabled="@(_filterState < FilterState.ReadyToSearch || _filterState == FilterState.RealTime)">
                SEARCH
            </MudButton>
        </MudItem>
        <MudItem xs="4" sm="3" md="1">
            <MudButton Variant="Variant.Outlined" OnClick="ResetFilters" FullWidth="true">
                Reset
            </MudButton>
        </MudItem>
        <MudItem xs="12" sm="3" md="1">
            <MudSelect T="int" Label="Real Interval"
                       Value="_selectedIntervalSeconds" ValueChanged="OnIntervalChanged"
                       Dense="true" Margin="Margin.Dense" Variant="Variant.Text"
                       Disabled="@(_filterState < FilterState.Searched)">
                <MudSelectItem T="int" Value="0">미지정</MudSelectItem>
                <MudSelectItem T="int" Value="10">10초</MudSelectItem>
                <MudSelectItem T="int" Value="60">1분</MudSelectItem>
                <MudSelectItem T="int" Value="300">5분</MudSelectItem>
            </MudSelect>
        </MudItem>
    </MudGrid>
</MudPaper>

@if (_isSearched)
{
    <MudGrid Spacing="3">
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Style="height:450px; position:relative;">
                <MudText Typo="Typo.h6" GutterBottom="true">@_selectedEqpId CPU Performance Trend</MudText>
                @if (_isLoading)
                {
                    <div class="d-flex justify-center align-center" style="height:calc(100% - 40px);">
                        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                    </div>
                }
                else if (_chartData.Any())
                {
                    <AmChart ChartData="_chartData" ChartConfig="_cpuChartConfig" Height="400px" ChartType="PerformanceLineChart" />
                }
                else
                {
                    <div class="d-flex justify-center align-center" style="height:400px;">
                        <MudText>데이터가 없습니다.</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Style="height:450px; position:relative;">
                <MudText Typo="Typo.h6" GutterBottom="true">@_selectedEqpId Memory Performance Trend</MudText>
                @if (_isLoading)
                {
                    <div class="d-flex justify-center align-center" style="height:calc(100% - 40px);">
                        <MudProgressCircular Color="Color.Info" Indeterminate="true" />
                    </div>
                }
                else if (_chartData.Any())
                {
                    <AmChart ChartData="_chartData" ChartConfig="_memoryChartConfig" Height="400px" ChartType="PerformanceLineChart" />
                }
                else
                {
                    <div class="d-flex justify-center align-center" style="height:400px;">
                        <MudText>데이터가 없습니다.</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>
        <MudItem xs="12">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" GutterBottom="true">Performance Summary</MudText>
                @* ▼▼▼ [핵심 수정 1/3] 성능 요약 테이블의 UI를 변경합니다. ▼▼▼ *@
                <MudSimpleTable Dense="true" Hover="true" Class="mt-2">
                    <thead>
                        <tr>
                            <th>EQP ID</th>
                            <th style="text-align:center">CPU Peak Time</th>
                            <th style="text-align:right">CPU Max (%)</th>
                            <th style="text-align:right">CPU Avg (%)</th>
                            <th style="text-align:center">Memory Peak Time</th>
                            <th style="text-align:right">Memory Max (%)</th>
                            <th style="text-align:right">Memory Avg (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var summary in _summaryData)
                        {
                            <tr>
                                <td>@summary.Key</td>
                                <td style="text-align:center">@summary.Value.CpuMaxTimestamp?.ToString("yy-MM-dd HH:mm:ss")</td>
                                <td style="text-align:right">@summary.Value.CpuMax.ToString("F2")</td>
                                <td style="text-align:right">@summary.Value.CpuAvg.ToString("F2")</td>
                                <td style="text-align:center">@summary.Value.MemoryMaxTimestamp?.ToString("yy-MM-dd HH:mm:ss")</td>
                                <td style="text-align:right">@summary.Value.MemoryMax.ToString("F2")</td>
                                <td style="text-align:right">@summary.Value.MemoryAvg.ToString("F2")</td>
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>
            </MudPaper>
        </MudItem>
    </MudGrid>
}
else
{
    <MudAlert Severity="Severity.Info">
        조회할 장비를 선택 후, 조회 버튼을 클릭하거나 실시간 조회를 시작하세요.
    </MudAlert>
}

@code {
    // ▼▼▼ [핵심 수정 2/3] 요약 데이터를 담을 새로운 클래스를 정의하고, _summaryData의 타입을 변경합니다. ▼▼▼
    public class PerformanceSummary
    {
        public double CpuAvg { get; set; }
        public double CpuMax { get; set; }
        public DateTime? CpuMaxTimestamp { get; set; }
        public double MemoryAvg { get; set; }
        public double MemoryMax { get; set; }
        public DateTime? MemoryMaxTimestamp { get; set; }
    }

    private Dictionary<string, PerformanceSummary> _summaryData = new();

    private enum FilterState { Initial, SelectSdwt, SelectEqpId, ReadyToSearch, Searched, RealTime }
    private FilterState _filterState = FilterState.Initial;
    private bool _isLoading = false;
    private bool _isSearched = false;
    private MudAutocomplete<string> _eqpIdAutocomplete;
    private string? _selectedSite;
    private string? _selectedSdwt;
    private string? _selectedEqpId;
    private DateTime? _startDate = DateTime.Now.Date.AddDays(-1);
    private DateTime? _endDate = DateTime.Now.Date;
    private List<string> _sites = new();
    private List<string> _sdwts = new();
    private List<string> _availableEqpIds = new();
    private List<PerformanceDataPointWithEqpIdDto> _chartData = new();
    private object _cpuChartConfig;
    private object _memoryChartConfig;
    private int _selectedIntervalSeconds = 0;
    private Timer? _timer;

    protected override async Task OnInitializedAsync()
    {
        var client = HttpClientFactory.CreateClient("ITM.Dashboard.Api");
        _sites = await client.GetFromJsonAsync<List<string>>("api/Filters/sites") ?? new();

        _cpuChartConfig = new
        {
            xField = "timestamp",
            xTimeUnit = "minute",
            xAxisDateFormat = "yy-MM-dd HH:mm",
            yAxes = new object[] { new { min = 0, max = 100 } },
            series = new[] { new { name = "CPU", valueField = "cpuUsage", color = "#33b2ff", bulletRadius = 4, strokeWidth = 1, tooltipText = "{valueX.formatDate('HH:mm:ss')} {name}: {valueY.formatNumber('#.00')}%" } }
        };

        _memoryChartConfig = new
        {
            xField = "timestamp",
            xTimeUnit = "minute",
            xAxisDateFormat = "yy-MM-dd HH:mm",
            yAxes = new object[] { new { min = 0, max = 100 } },
            series = new[] { new { name = "Memory", valueField = "memoryUsage", color = "#39e6a3", bulletRadius = 4, strokeWidth = 1, tooltipText = "{valueX.formatDate('HH:mm:ss')} {name}: {valueY.formatNumber('#.00')}%" } }
        };
    }

    private async Task OnSiteChanged(string site)
    {
        _selectedSite = site;
        _selectedSdwt = null;
        _selectedEqpId = null;
        _sdwts.Clear();
        _availableEqpIds.Clear();

        if (string.IsNullOrEmpty(site))
        {
            _filterState = FilterState.Initial;
        }
        else
        {
            var client = HttpClientFactory.CreateClient("ITM.Dashboard.Api");
            _sdwts = await client.GetFromJsonAsync<List<string>>($"api/Filters/sdwts/{site}") ?? new();
            _filterState = FilterState.SelectSdwt;
        }
        StateHasChanged();
    }

    private async Task OnSdwtChanged(string sdwt)
    {
        _selectedSdwt = sdwt;
        _selectedEqpId = null;
        _availableEqpIds.Clear();

        if (string.IsNullOrEmpty(sdwt))
        {
            _filterState = FilterState.SelectSdwt;
        }
        else
        {
            var client = HttpClientFactory.CreateClient("ITM.Dashboard.Api");
            _availableEqpIds = await client.GetFromJsonAsync<List<string>>($"api/Filters/eqpids/{sdwt}") ?? new();
            _filterState = FilterState.SelectEqpId;
        }
        StateHasChanged();
    }

    private Task OnSelectedEqpIdChanged(string eqpid)
    {
        _selectedEqpId = eqpid;
        _filterState = string.IsNullOrEmpty(eqpid) ? FilterState.SelectEqpId : FilterState.ReadyToSearch;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task OnSearchClicked()
    {
        if (string.IsNullOrEmpty(_selectedEqpId)) return;
        _isLoading = true;
        _isSearched = true;
        ClearResults();
        StateHasChanged();
        await Task.Delay(1);

        await UpdateChartDataAsync();
        _isLoading = false;
        _filterState = FilterState.Searched;
        StateHasChanged();
    }

    private async Task OnIntervalChanged(int interval)
    {
        _selectedIntervalSeconds = interval;
        if (interval > 0)
        {
            _filterState = FilterState.RealTime;
            await StartTimerAsync();
        }
        else
        {
            _filterState = FilterState.Searched;
            await StopTimerAsync();
        }
        StateHasChanged();
    }

    private async Task ResetFilters()
    {
        _selectedSite = _selectedSdwt = _selectedEqpId = null;
        _startDate = DateTime.Now.Date.AddDays(-1);
        _endDate = DateTime.Now.Date;
        _sdwts.Clear();
        _availableEqpIds.Clear();
        if (_eqpIdAutocomplete != null)
            await _eqpIdAutocomplete.ResetAsync();
        ClearResults();
        _isSearched = false;
        await StopTimerAsync();
        _selectedIntervalSeconds = 0;
        _filterState = FilterState.Initial;
        StateHasChanged();
    }

    private async Task StartTimerAsync()
    {
        if (string.IsNullOrEmpty(_selectedEqpId)) return;
        await StopTimerAsync();
        _isSearched = true;
        var interval = TimeSpan.FromSeconds(_selectedIntervalSeconds);
        _timer = new Timer(async _ => await UpdateChartDataAsync(), null, TimeSpan.Zero, interval);
    }

    private async Task StopTimerAsync()
    {
        if (_timer != null)
        {
            await _timer.DisposeAsync();
            _timer = null;
        }
    }

    private async Task UpdateChartDataAsync()
    {
        if (string.IsNullOrEmpty(_selectedEqpId)) return;
        try
        {
            DateTime start, end;
            int intervalToUse = _selectedIntervalSeconds;
            if (_filterState == FilterState.RealTime && intervalToUse > 0)
            {
                end = DateTime.Now;
                start = end.AddHours(-1);
            }
            else
            {
                start = _startDate ?? DateTime.Now.Date.AddDays(-1);
                end = (_endDate ?? DateTime.Now.Date).AddDays(1);
                var dateDiffDays = (end - start).TotalDays;
                if (dateDiffDays <= 1) intervalToUse = 5;
                else if (dateDiffDays <= 3) intervalToUse = 10;
                else if (dateDiffDays <= 7) intervalToUse = 60;
                else if (dateDiffDays <= 30) intervalToUse = 600;
                else intervalToUse = 1800;
            }

            var client = HttpClientFactory.CreateClient("ITM.Dashboard.Api");
            var query = new System.Text.StringBuilder();
            query.Append($"startDate={Uri.EscapeDataString(start.ToString("o"))}");
            query.Append($"&endDate={Uri.EscapeDataString(end.ToString("o"))}");
            query.Append($"&intervalSeconds={intervalToUse}");
            query.Append($"&eqpids={Uri.EscapeDataString(_selectedEqpId)}");
            var data = await client.GetFromJsonAsync<List<PerformanceDataPointWithEqpIdDto>>($"api/PerformanceAnalytics/history?{query}");

            if (data != null && data.Any())
            {
                _chartData = data;
                CalculateSummary(data);
            }
            else
                ClearResults();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"데이터 조회 중 오류 발생: {ex.Message}", Severity.Error);
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    // ▼▼▼ [핵심 수정 3/3] CalculateSummary 메서드의 로직을 변경하여 Max 발생 시점을 찾습니다. ▼▼▼
    private void CalculateSummary(List<PerformanceDataPointWithEqpIdDto> data)
    {
        _summaryData.Clear();
        foreach (var group in data.GroupBy(d => d.EqpId))
        {
            if (!group.Any()) continue;

            // CPU 사용량이 가장 높은 데이터 포인트를 찾습니다.
            var maxCpuPoint = group.OrderByDescending(d => d.CpuUsage).FirstOrDefault();

            // Memory 사용량이 가장 높은 데이터 포인트를 찾습니다.
            var maxMemoryPoint = group.OrderByDescending(d => d.MemoryUsage).FirstOrDefault();

            _summaryData[group.Key] = new PerformanceSummary
            {
                CpuAvg = group.Average(d => d.CpuUsage),
                CpuMax = maxCpuPoint?.CpuUsage ?? 0,
                CpuMaxTimestamp = maxCpuPoint?.Timestamp,
                MemoryAvg = group.Average(d => d.MemoryUsage),
                MemoryMax = maxMemoryPoint?.MemoryUsage ?? 0,
                MemoryMaxTimestamp = maxMemoryPoint?.Timestamp
            };
        }
    }

    private void ClearResults()
    {
        _chartData.Clear();
        _summaryData.Clear();
    }

    public async ValueTask DisposeAsync()
    {
        if (_timer != null)
            await _timer.DisposeAsync();
    }

    private async Task<IEnumerable<string>> SearchEqpids(string value, CancellationToken token)
    {
        await Task.Yield();
        if (string.IsNullOrEmpty(value))
            return _availableEqpIds.Take(10);
        return _availableEqpIds.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }
}
